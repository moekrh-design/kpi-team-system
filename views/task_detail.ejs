<%- include('partials/header', { pageTitle: 'ุชูุงุตูู ุงููููุฉ' }) %>

<div class="grid" style="max-width:1100px;margin:0 auto">
  <% if (ok) { %>
    <div class="notice">ุชู ุญูุธ ุงูุนูููุฉ ุจูุฌุงุญ โ</div>
  <% } %>

  <% if (error) { %>
    <div class="error"><%= error %></div>
  <% } %>

  <% if (emailSent) { %>
    <div class="notice">ุชู ุฅุฑุณุงู ุงูุชุฐููุฑ ุจุงูุจุฑูุฏ โ</div>
  <% } %>

  <% if (emailErr) { %>
    <div class="error"><%= emailErr %></div>
  <% } %>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <h2 style="margin:0"><%= task.title %></h2>
        <div class="small">ุงูููุงุณุจุฉ: <b><%= task.event_title || '-' %></b> โข ุงูููุธู: <b><%= task.employee_name || '-' %></b> โข ุงููุดุฑู: <b><%= task.supervisor_name || '-' %></b></div>
        <% if (task.event_id) { %>
          <div class="small noPrint" style="margin-top:8px">
            <a class="btn" href="/events/<%= task.event_id %>/files" target="_blank">ูููุงุช ุงููุดุฑูุน</a>
          </div>
        <% } %>
      </div>
      <div class="rowActions noPrint">
        <a class="btn" href="/tasks">ุฑุฌูุน</a>
        <% if (me.role !== 'employee') { %>
          <form action="/tasks/<%= task.id %>/remind-email" method="post" style="display:inline" onsubmit="return confirm('ุฅุฑุณุงู ุชุฐููุฑ ุจุงูุจุฑูุฏ ูููุณูุฏ ููุ');">
            <button class="btn" type="submit">ุชุฐููุฑ ุจุฑูุฏ</button>
          </form>
          <a class="btn" href="/tasks/<%= task.id %>/edit">ุชุนุฏูู</a>
          <form action="/tasks/<%= task.id %>?_method=DELETE" method="post" style="display:inline" onsubmit="return confirm('ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููููุฉุ ุณูุชู ุญุฐู ุฌููุน ุงููุฑููุงุช ูุงูุณุฌูุงุช ุงููุฑุชุจุทุฉ.');">
            <button class="btn btnDanger" type="submit">ุญุฐู</button>
          </form>
        <% } %>
      </div>
    </div>

    <% if (task.description) { %>
      <div class="hr"></div>
      <div class="small"><%= task.description %></div>
    <% } %>

    <div class="hr"></div>

    <div class="grid grid2">
      <div>
        <div class="small">ุงูุญุงูุฉ</div>
        <div style="margin-top:6px">
          <% if (task.status === 'completed') { %>
            <span class="badge bGood">ููุชููุฉ</span>
          <% } else if (task.status === 'pending_approval') { %>
            <span class="badge bWarn">ุจุงูุชุธุงุฑ ุงุนุชูุงุฏ</span>
          <% } else if (task.status === 'overdue') { %>
            <span class="badge bBad">ูุชุฃุฎุฑุฉ</span>
          <% } else if (task.status === 'cancelled') { %>
            <span class="badge">ููุบุงุฉ</span>
          <% } else { %>
            <span class="badge bInfo">ุฌุงุฑูุฉ</span>
          <% } %>
        </div>
        <div class="small" style="margin-top:10px">ุงูุฃููููุฉ: <b><%= task.priority %></b></div>
        <% if (task.start_date) { %><div class="small">ุจุฏุงูุฉ: <b><%= fmtDate(task.start_date) %></b></div><% } %>
        <% if (task.due_date) { %><div class="small">ุงูุงุณุชุญูุงู: <b><%= fmtDate(task.due_date) %></b></div><% } %>
      </div>

      <div>
        <div class="small">ุงูุชูุฏู</div>
        <div style="margin-top:10px" class="progressWrap status-<%= task.status %>">
          <div class="bar"><span style="width:<%= task.progress %>%"></span></div>
          <div class="small"><%= task.progress %>%</div>
        </div>
        <div class="small" style="margin-top:8px">ุงูููุฌุฒ: <b><%= task.done_value %></b> / ุงููุณุชูุฏู: <b><%= task.target_value %></b></div>
      </div>
    </div>
  </div>

  <!-- Put "Update progress" first, and move attachments below it (not side-by-side) -->
  <div class="grid">
    <div class="card">
      <h3 style="margin:0 0 10px 0">ุชุญุฏูุซ ุงูุฅูุฌุงุฒ</h3>

      <% if (String(task.progress_mode || 'simple') === 'stages') { %>
        <div class="help" style="margin-bottom:10px">
          ูุฐู ุงููููุฉ ููุณููุฉ ุฅูู ูุฑุงุญู. ูู ุจุชุญุฏูุซ ุงููุฑุญูุฉ ุงููุณูุฏุฉ ูู (ุฃู ุงุนุชูุฏ ุงูุฅูุฌุงุฒ ุฅุฐุง ููุช ูุดุฑููุง).
        </div>

        <% if (!stages || !stages.length) { %>
          <div class="small">ูุง ุชูุฌุฏ ูุฑุงุญู ูู ูุฐู ุงููููุฉ.</div>
        <% } else { %>
          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>ุงููุฑุญูุฉ</th>
                  <th>ุงููุณูุฏ</th>
                  <th>ุงููุฒู</th>
                  <th>ุงูุชูุฏู</th>
                  <th>ุงูุญุงูุฉ</th>
                  <th class="noPrint">ุชุญุฏูุซ</th>
                </tr>
              </thead>
              <tbody>
                <% stages.forEach(s => { %>
                  <% const canEdit = (me.role === 'admin') || (me.role === 'supervisor') || (me.role === 'employee' && s.assigned_to === me.id); %>
                  <tr>
                    <td class="small"><b><%= s.stage_name %></b></td>
                    <td class="small"><%= s.assigned_to_name || '-' %></td>
                    <td class="small"><%= Math.round((Number(s.weight||0)) * 10) / 10 %>%</td>
                    <td style="min-width:210px">
                      <div class="progressWrap status-<%= s.status %>">
                        <div class="bar"><span style="width:<%= s.progress || 0 %>%"></span></div>
                        <div class="small"><%= s.progress || 0 %>%</div>
                      </div>
                    </td>
                    <td class="small"><%= s.status %></td>
                    <td class="noPrint" style="min-width:280px">
                      <% if (canEdit) { %>
                        <form method="post" action="/stages/<%= s.id %>/update" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                          <input class="input" type="number" name="progress" min="0" max="100" step="5" value="<%= s.progress || 0 %>" style="width:110px" />
                          <button class="btn btnGood" type="submit">ุญูุธ</button>
                          <button class="btn" type="submit" name="done" value="1">ุชู โ</button>
                          <input class="input" name="note" placeholder="ููุงุญุธุฉ (ุงุฎุชูุงุฑู)" style="width:220px" />
                        </form>
                      <% } else { %>
                        <span class="small" style="color:var(--muted)">ุบูุฑ ูุณูุฏ ูู</span>
                      <% } %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>

        <% if ((me.role !== 'employee' || Number(me.can_approve_tasks||0)===1) && task.status === 'pending_approval') { %>
          <div class="hr"></div>
          <h3 style="margin:0 0 10px 0">ุงุนุชูุงุฏ ุงููุดุฑู</h3>
          <form method="post" action="/tasks/<%= task.id %>/approve" class="grid">
            <div class="formRow">
              <div>
                <label class="small">ุงููุฑุงุฑ</label>
                <select class="input" name="decision" required>
                  <option value="approved">ุงุนุชูุงุฏ โ</option>
                  <option value="rejected">ุฑูุถ / ุฅุนุงุฏุฉ ููุชุนุฏูู ๐</option>
                </select>
              </div>
              <div>
                <label class="small">ุชุนููู (ุงุฎุชูุงุฑู)</label>
                <input class="input" name="comment" placeholder="ููุงุญุธุฉ ูููููููุฐ..." />
              </div>
            </div>
            <button class="btn btnGood" type="submit">ุชุณุฌูู ุงููุฑุงุฑ</button>
          </form>
        <% } %>

      <% } else { %>
        <form method="post" action="/tasks/<%= task.id %>/update" class="grid">
          <div>
            <label class="small">ูููุฉ ุงูููุฌุฒ ุงูุญุงููุฉ</label>
            <input class="input" type="number" step="0.01" name="done_value" value="<%= task.done_value %>" />
          </div>
          <div>
            <label class="small">ููุงุญุธุฉ (ุงุฎุชูุงุฑู)</label>
            <textarea class="input" name="note" placeholder="ุงูุชุจ ุชูุถูุญ ูุฎุชุตุฑ..."></textarea>
          </div>
          <button class="btn btnGood" type="submit">ุญูุธ ุงูุชุญุฏูุซ</button>
          <div class="help">
            ุนูุฏ ุงููุตูู ุฅูู <b>100%</b> ุชุชุญูู ุงููููุฉ ุชููุงุฆููุง ุฅูู <b>ุจุงูุชุธุงุฑ ุงุนุชูุงุฏ</b>.
            <br/>ุจุนุฏ ุฐูู ููุณุฌูู ุงููุดุฑู/ุงููุฏูุฑ ูุฑุงุฑ ุงูุงุนุชูุงุฏ ูุชุตุจุญ <b>ููุชููุฉ</b>.
          </div>
        </form>

        <% if ((me.role !== 'employee' || Number(me.can_approve_tasks||0)===1) && task.status === 'pending_approval') { %>
          <div class="hr"></div>
          <h3 style="margin:0 0 10px 0">ุงุนุชูุงุฏ ุงููุดุฑู</h3>
          <form method="post" action="/tasks/<%= task.id %>/approve" class="grid">
            <div class="formRow">
              <div>
                <label class="small">ุงููุฑุงุฑ</label>
                <select class="input" name="decision" required>
                  <option value="approved">ุงุนุชูุงุฏ โ</option>
                  <option value="rejected">ุฑูุถ / ุฅุนุงุฏุฉ ููุชุนุฏูู ๐</option>
                </select>
              </div>
              <div>
                <label class="small">ุชุนููู (ุงุฎุชูุงุฑู)</label>
                <input class="input" name="comment" placeholder="ููุงุญุธุฉ ูููููููุฐ..." />
              </div>
            </div>
            <button class="btn btnGood" type="submit">ุชุณุฌูู ุงููุฑุงุฑ</button>
          </form>
        <% } %>
      <% } %>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0">ุงููุฑููุงุช</h3>
      <form class="grid noPrint" method="post" action="/tasks/<%= task.id %>/attach" enctype="multipart/form-data">
        <div>
          <label class="small">ุฑูุน ููู (PDF/ุตูุฑ)</label>
          <input class="input" type="file" name="file" accept=".pdf,image/*" required />
          <div class="help">ุงูุญุฏ ุงูุฃุนูู: 20MB ููู ููู</div>
        </div>
        <button class="btn" type="submit">ุฑูุน ุงููุฑูู</button>
      </form>

      <div class="hr"></div>
      <% if (!attachments.length) { %>
        <div class="small">ูุง ุชูุฌุฏ ูุฑููุงุช.</div>
      <% } else { %>
        <div style="overflow:auto">
          <table class="table">
            <thead>
              <tr>
                <th>ุงูููู</th>
                <th>ุงูุฑุงูุน</th>
                <th>ุงูุชุงุฑูุฎ</th>
                <th class="noPrint">ูุชุญ</th>
              </tr>
            </thead>
            <tbody>
              <% attachments.forEach(a => { %>
                <tr>
                  <td class="small"><%= a.original_name %></td>
                  <td class="small"><%= a.uploaded_by_name || '-' %></td>
                  <td class="small"><%= fmtDate(a.uploaded_at) %></td>
                  <td class="noPrint"><a class="btn" href="/uploads/<%= a.stored_filename %>" target="_blank">ุนุฑุถ</a></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>

  <div class="grid grid2">
    <div class="card">
      <h3 style="margin:0 0 10px 0">ุณุฌู ุงูุชุญุฏูุซุงุช</h3>
      <% if (!updates.length) { %>
        <div class="small">ูุง ููุฌุฏ ุชุญุฏูุซุงุช.</div>
      <% } else { %>
        <div style="overflow:auto">
          <table class="table">
            <thead>
              <tr>
                <th>ุงููููุฉ</th>
                <th>ุงูููุงุญุธุฉ</th>
                <th>ุจูุงุณุทุฉ</th>
                <th>ุงูุชุงุฑูุฎ</th>
              </tr>
            </thead>
            <tbody>
              <% updates.forEach(u => { %>
                <tr>
                  <td class="small"><%= (u.done_value ?? '-') %></td>
                  <td class="small"><%= u.note || '-' %></td>
                  <td class="small"><%= u.created_by_name || '-' %></td>
                  <td class="small"><%= fmtDate(u.created_at) %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px 0">ุณุฌู ุงูุงุนุชูุงุฏ</h3>
      <% if (!approvals.length) { %>
        <div class="small">ูุง ููุฌุฏ ุงุนุชูุงุฏุงุช.</div>
      <% } else { %>
        <div style="overflow:auto">
          <table class="table">
            <thead>
              <tr>
                <th>ุงููุฑุงุฑ</th>
                <th>ุงูุชุนููู</th>
                <th>ุงููุนุชูุฏ</th>
                <th>ุงูุชุงุฑูุฎ</th>
              </tr>
            </thead>
            <tbody>
              <% approvals.forEach(a => { %>
                <tr>
                  <td>
                    <% if (a.decision === 'approved') { %>
                      <span class="badge bGood">ุงุนุชูุงุฏ</span>
                    <% } else { %>
                      <span class="badge bWarn">ุฅุฑุฌุงุน</span>
                    <% } %>
                  </td>
                  <td class="small"><%= a.comment || '-' %></td>
                  <td class="small"><%= a.approved_by_name || '-' %></td>
                  <td class="small"><%= fmtDate(a.approved_at) %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
